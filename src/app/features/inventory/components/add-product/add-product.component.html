<div class="add-product-page">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <button mat-icon-button class="back-button" (click)="onCancel()">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <h1>{{ isEditMode ? 'Edit Product' : 'Add New Product' }}</h1>
    </div>
  </div>

  <!-- Loading Spinner -->
  @if (isLoading) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading product...</p>
    </div>
  }

  <!-- Main Content -->
  @if (!isLoading) {
    <div class="page-content">
      <mat-card class="form-card">
        <!-- Error Message -->
        @if (errorMessage()) {
          <div class="error-message">
            <mat-icon>error</mat-icon>
            <span>{{ errorMessage() }}</span>
          </div>
        }

        <form [formGroup]="productForm" class="product-form">
          
          <!-- Product Name -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Product Name</mat-label>
            <input matInput formControlName="name" />
            <mat-error *ngIf="productForm.get('name')?.invalid && productForm.get('name')?.touched">
              {{ getErrorMessage('name') }}
            </mat-error>
          </mat-form-field>

          <!-- Description -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Description</mat-label>
            <textarea matInput 
                      formControlName="description" 
                      rows="3"></textarea>
          </mat-form-field>

          <!-- Category Selection -->
          <div class="category-row">
            <mat-form-field appearance="outline" class="category-field">
              <mat-label>Category</mat-label>
              <mat-select formControlName="categoryId">
                <mat-option value="">None</mat-option>
                <mat-option *ngFor="let category of categories" [value]="category.id">
                  {{ category.name }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <button type="button" 
                    class="retail-pro-btn retail-pro-btn--secondary add-category-btn" 
                    (click)="openAddCategoryDialog()"
                    title="Add new category">
              <mat-icon>add</mat-icon>
              Add
            </button>
          </div>

          <!-- Sub-Category Selection -->
          <div class="category-row">
            <mat-form-field appearance="outline" class="category-field">
              <mat-label>Sub-Category</mat-label>
              <mat-select formControlName="subCategoryId" 
                          [disabled]="!productForm.get('categoryId')?.value">
                <mat-option value="">None</mat-option>
                <mat-option *ngFor="let subCategory of filteredSubCategories" [value]="subCategory.id">
                  {{ subCategory.name }}
                </mat-option>
              </mat-select>
              <mat-hint *ngIf="!productForm.get('categoryId')?.value">
                Select a category first
              </mat-hint>
            </mat-form-field>
            <button type="button" 
                    class="retail-pro-btn retail-pro-btn--secondary add-category-btn" 
                    (click)="openAddSubCategoryDialog()"
                    [disabled]="!productForm.get('categoryId')?.value"
                    title="Add new sub-category">
              <mat-icon>add</mat-icon>
              Add
            </button>
          </div>

          <!-- Quantity Row -->
          <div class="quantity-row">
            <mat-form-field appearance="outline" class="quantity-field">
              <mat-label>Quantity</mat-label>
              <input matInput 
                     type="number" 
                     formControlName="quantity" 
                     placeholder=""
                     min="0"
                     step="1">
              <mat-error *ngIf="productForm.get('quantity')?.invalid && productForm.get('quantity')?.touched">
                {{ getErrorMessage('quantity') }}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="quantity-field">
              <mat-label>Minimum Quantity</mat-label>
              <input matInput 
                     type="number" 
                     formControlName="minimumQuantity" 
                     placeholder=""
                     min="0"
                     step="1">
              <mat-error *ngIf="productForm.get('minimumQuantity')?.invalid && productForm.get('minimumQuantity')?.touched">
                {{ getErrorMessage('minimumQuantity') }}
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Barcode with Generate Button -->
          <div class="barcode-section">
            <mat-form-field appearance="outline" class="barcode-input">
              <mat-label>Barcode</mat-label>
              <input matInput 
                     formControlName="barcode" />
              <mat-error *ngIf="productForm.get('barcode')?.invalid && productForm.get('barcode')?.touched">
                {{ getErrorMessage('barcode') }}
              </mat-error>
            </mat-form-field>
            <button type="button" class="retail-pro-btn retail-pro-btn--secondary generate-btn" 
                    (click)="generateBarcode()">
              <mat-icon>qr_code</mat-icon>
              Generate
            </button>
          </div>

          <!-- Price and MRP Row -->
          <div class="price-row">
            <mat-form-field appearance="outline" class="price-field">
              <mat-label>Selling Price</mat-label>
              <input matInput 
                     type="number" 
                     formControlName="price" 
                     placeholder=""
                     min="0"
                     step="0.01">
              <span matTextPrefix>₹&nbsp;</span>
              <mat-error *ngIf="productForm.get('price')?.invalid && productForm.get('price')?.touched">
                {{ getErrorMessage('price') }}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="price-field">
              <mat-label>MRP </mat-label>
              <input matInput 
                     type="number" 
                     formControlName="mrp" 
                     placeholder=""
                     min="0"
                     step="0.01">
              <span matTextPrefix>₹&nbsp;</span>
              <mat-error *ngIf="productForm.get('mrp')?.invalid && productForm.get('mrp')?.touched">
                {{ getErrorMessage('mrp') }}
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Active Status -->
          <div class="checkbox-section">
            <mat-checkbox formControlName="isActive" color="primary">
              Active Product
            </mat-checkbox>
            <small class="checkbox-help">Inactive products won't appear in sales</small>
          </div>

        </form>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" 
                  class="retail-pro-btn retail-pro-btn--secondary" 
                  (click)="onCancel()">
            <mat-icon>close</mat-icon>
            Cancel
          </button>
          <button type="button" 
                  class="retail-pro-btn retail-pro-btn--primary" 
                  (click)="onSubmit()"
                  [disabled]="!productForm.valid || isSubmitting">
            <mat-icon *ngIf="!isSubmitting">{{ isEditMode ? 'save' : 'add' }}</mat-icon>
            <mat-icon *ngIf="isSubmitting" class="spinning">sync</mat-icon>
            {{ isSubmitting ? (isEditMode ? 'Updating...' : 'Adding...') : (isEditMode ? 'Update Product' : 'Add Product') }}
          </button>
        </div>
      </mat-card>
    </div>
  }
</div>

<!-- Add Category Dialog -->
@if (showAddCategoryDialog) {
  <div class="overlay" (click)="closeAddCategoryDialog()">
    <div class="quick-add-dialog" (click)="$event.stopPropagation()">
      <div class="quick-add-header">
        <h3>Add New Category</h3>
        <button mat-icon-button (click)="closeAddCategoryDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="quick-add-content">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Category Name</mat-label>
          <input matInput 
                 [(ngModel)]="newCategoryName" 
                 (keydown.enter)="addNewCategory()"
                 placeholder="Enter category name" 
                 autofocus>
        </mat-form-field>
      </div>
      <div class="quick-add-actions">
        <button type="button" 
                class="retail-pro-btn retail-pro-btn--secondary" 
                (click)="closeAddCategoryDialog()">
          Cancel
        </button>
        <button type="button" 
                class="retail-pro-btn retail-pro-btn--primary" 
                (click)="addNewCategory()"
                [disabled]="!newCategoryName.trim() || isAddingCategory">
          <mat-icon *ngIf="!isAddingCategory">add</mat-icon>
          <mat-icon *ngIf="isAddingCategory" class="spinning">sync</mat-icon>
          {{ isAddingCategory ? 'Adding...' : 'Add Category' }}
        </button>
      </div>
    </div>
  </div>
}

<!-- Add Sub-Category Dialog -->
@if (showAddSubCategoryDialog) {
  <div class="overlay" (click)="closeAddSubCategoryDialog()">
    <div class="quick-add-dialog" (click)="$event.stopPropagation()">
      <div class="quick-add-header">
        <h3>Add New Sub-Category</h3>
        <button mat-icon-button (click)="closeAddSubCategoryDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="quick-add-content">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Sub-Category Name</mat-label>
          <input matInput 
                 [(ngModel)]="newSubCategoryName" 
                 (keydown.enter)="addNewSubCategory()"
                 placeholder="Enter sub-category name" 
                 autofocus>
        </mat-form-field>
      </div>
      <div class="quick-add-actions">
        <button type="button" 
                class="retail-pro-btn retail-pro-btn--secondary" 
                (click)="closeAddSubCategoryDialog()">
          Cancel
        </button>
        <button type="button" 
                class="retail-pro-btn retail-pro-btn--primary" 
                (click)="addNewSubCategory()"
                [disabled]="!newSubCategoryName.trim() || isAddingSubCategory">
          <mat-icon *ngIf="!isAddingSubCategory">add</mat-icon>
          <mat-icon *ngIf="isAddingSubCategory" class="spinning">sync</mat-icon>
          {{ isAddingSubCategory ? 'Adding...' : 'Add Sub-Category' }}
        </button>
      </div>
    </div>
  </div>
}
