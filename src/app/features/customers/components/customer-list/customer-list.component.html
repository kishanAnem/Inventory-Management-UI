<!-- Customer List Header -->
<div class="retail-pro-card mb-4">
  <div class="retail-pro-card-header">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2 class="retail-pro-title mb-1">Customer Management</h2>
        <p class="text-muted mb-0">Manage your customer database and relationships</p>
      </div>
      <div class="d-flex gap-2">
        <button 
          mat-raised-button 
          color="primary" 
          class="retail-pro-btn retail-pro-btn-primary"
          (click)="openCustomerForm()">
          <mat-icon>person_add</mat-icon>
          Add Customer
        </button>
        <button 
          mat-stroked-button 
          class="retail-pro-btn"
          (click)="exportToCSV()">
          <mat-icon>download</mat-icon>
          Export
        </button>
        <input 
          type="file" 
          #fileInput 
          accept=".csv" 
          style="display: none" 
          (change)="onFileSelected($event)">
        <button 
          mat-stroked-button 
          class="retail-pro-btn"
          (click)="fileInput.click()">
          <mat-icon>upload</mat-icon>
          Import
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Customer Stats Cards -->
<div class="row mb-4">
  <div class="col-md-4">
    <div class="retail-pro-card retail-pro-card-stats">
      <div class="retail-pro-card-body">
        <div class="d-flex align-items-center">
          <div class="retail-pro-stats-icon bg-primary">
            <mat-icon>people</mat-icon>
          </div>
          <div class="ms-3">
            <h3 class="retail-pro-stats-number mb-0">{{ totalCustomers }}</h3>
            <p class="retail-pro-stats-label mb-0">Total Customers</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="retail-pro-card retail-pro-card-stats">
      <div class="retail-pro-card-body">
        <div class="d-flex align-items-center">
          <div class="retail-pro-stats-icon bg-success">
            <mat-icon>verified_user</mat-icon>
          </div>
          <div class="ms-3">
            <h3 class="retail-pro-stats-number mb-0">{{ activeCustomers }}</h3>
            <p class="retail-pro-stats-label mb-0">Active Customers</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="retail-pro-card retail-pro-card-stats">
      <div class="retail-pro-card-body">
        <div class="d-flex align-items-center">
          <div class="retail-pro-stats-icon bg-warning">
            <mat-icon>trending_up</mat-icon>
          </div>
          <div class="ms-3">
            <h3 class="retail-pro-stats-number mb-0">{{ ((activeCustomers / totalCustomers) * 100) | number:'1.0-0' }}%</h3>
            <p class="retail-pro-stats-label mb-0">Active Rate</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Search and Actions Bar -->
<div class="retail-pro-card mb-4">
  <div class="retail-pro-card-body">
    <div class="row align-items-center">
      <div class="col-md-6">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Search customers</mat-label>
          <input 
            matInput 
            [(ngModel)]="searchTerm" 
            (keyup.enter)="applyFilter()"
            placeholder="Search by name, email, or phone">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
      </div>
      <div class="col-md-6 text-end">
        <button 
          mat-raised-button 
          color="primary" 
          class="retail-pro-btn retail-pro-btn-primary me-2"
          (click)="applyFilter()"
          [disabled]="!searchTerm.trim()">
          Search
        </button>
        <button 
          mat-stroked-button 
          class="retail-pro-btn me-3"
          (click)="clearSearch()"
          [disabled]="!searchTerm">
          Clear
        </button>
        <button 
          mat-raised-button 
          color="warn" 
          class="retail-pro-btn retail-pro-btn-danger"
          (click)="deleteSelectedCustomers()"
          [disabled]="selection.selected.length === 0">
          <mat-icon>delete</mat-icon>
          Delete Selected ({{ selection.selected.length }})
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Customer Table -->
<div class="retail-pro-card">
  <div class="retail-pro-card-header">
    <h5 class="mb-0">Customer List</h5>
  </div>
  <div class="retail-pro-card-body p-0">
    <!-- Loading Spinner -->
    <div *ngIf="isLoading" class="text-center p-4">
      <mat-spinner diameter="40"></mat-spinner>
      <p class="mt-2 text-muted">Loading customers...</p>
    </div>

    <!-- Customer Table -->
    <div *ngIf="!isLoading" class="table-responsive">
      <table mat-table [dataSource]="dataSource" class="retail-pro-table w-100" matSort>
        
        <!-- Checkbox Column -->
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef class="retail-pro-table-header">
            <mat-checkbox 
              (change)="$event ? masterToggle() : null"
              [checked]="selection.hasValue() && isAllSelected()"
              [indeterminate]="selection.hasValue() && !isAllSelected()"
              [aria-label]="checkboxLabel()">
            </mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let customer" class="retail-pro-table-cell">
            <mat-checkbox 
              (click)="$event.stopPropagation()"
              (change)="$event ? selection.toggle(customer) : null"
              [checked]="selection.isSelected(customer)"
              [aria-label]="checkboxLabel(customer)">
            </mat-checkbox>
          </td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="retail-pro-table-header">Name</th>
          <td mat-cell *matCellDef="let customer" class="retail-pro-table-cell">
            <div class="d-flex align-items-center">
              <div class="retail-pro-avatar me-2">
                {{ customer.name?.charAt(0) | uppercase }}
              </div>
              <div>
                <div class="fw-semibold">{{ customer.name }}</div>
                <small class="text-muted">ID: {{ customer.id?.substring(0, 8) }}...</small>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Email Column -->
        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="retail-pro-table-header">Email</th>
          <td mat-cell *matCellDef="let customer" class="retail-pro-table-cell">
            <a [href]="'mailto:' + customer.email" class="text-decoration-none">{{ customer.email }}</a>
          </td>
        </ng-container>

        <!-- Phone Column -->
        <ng-container matColumnDef="phone">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="retail-pro-table-header">Phone</th>
          <td mat-cell *matCellDef="let customer" class="retail-pro-table-cell">
            <a [href]="'tel:' + customer.phone" class="text-decoration-none">{{ customer.phone }}</a>
          </td>
        </ng-container>

        <!-- Address Column -->
        <ng-container matColumnDef="address">
          <th mat-header-cell *matHeaderCellDef class="retail-pro-table-header">Address</th>
          <td mat-cell *matCellDef="let customer" class="retail-pro-table-cell">
            <span [title]="customer.address">{{ customer.address | slice:0:30 }}{{ (customer.address?.length || 0) > 30 ? '...' : '' }}</span>
          </td>
        </ng-container>

        <!-- City Column -->
        <ng-container matColumnDef="city">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="retail-pro-table-header">City</th>
          <td mat-cell *matCellDef="let customer" class="retail-pro-table-cell">{{ customer.city || '-' }}</td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="isActive">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="retail-pro-table-header">Status</th>
          <td mat-cell *matCellDef="let customer" class="retail-pro-table-cell">
            <span class="retail-pro-badge" [ngClass]="getStatusClass(customer.isActive)">
              {{ getStatusText(customer.isActive) }}
            </span>
          </td>
        </ng-container>

        <!-- Created Date Column -->
        <ng-container matColumnDef="createdAt">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="retail-pro-table-header">Created</th>
          <td mat-cell *matCellDef="let customer" class="retail-pro-table-cell">
            {{ customer.createdAt | date:'MMM dd, yyyy' }}
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="retail-pro-table-header">Actions</th>
          <td mat-cell *matCellDef="let customer" class="retail-pro-table-cell">
            <div class="d-flex gap-1">
              <button 
                mat-icon-button 
                [matTooltip]="'View Details'"
                (click)="viewCustomerDetail(customer)">
                <mat-icon>visibility</mat-icon>
              </button>
              <button 
                mat-icon-button 
                [matTooltip]="'Edit Customer'"
                (click)="openCustomerForm(customer)">
                <mat-icon>edit</mat-icon>
              </button>
              <button 
                mat-icon-button 
                [matTooltip]="'Send WhatsApp'"
                (click)="sendWhatsAppMessage(customer)"
                *ngIf="customer.whatsAppNumber">
                <mat-icon>message</mat-icon>
              </button>
              <button 
                mat-icon-button 
                [matTooltip]="'Delete Customer'"
                color="warn"
                (click)="deleteCustomer(customer)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr 
          mat-row 
          *matRowDef="let customer; columns: displayedColumns;"
          class="retail-pro-table-row"
          (click)="viewCustomerDetail(customer)">
        </tr>
      </table>

      <!-- No Data Message -->
      <div *ngIf="dataSource.data.length === 0 && !isLoading" class="text-center p-5">
        <mat-icon class="text-muted" style="font-size: 48px; height: 48px; width: 48px;">people_outline</mat-icon>
        <h5 class="text-muted mt-3">No customers found</h5>
        <p class="text-muted">Add your first customer to get started</p>
        <button 
          mat-raised-button 
          color="primary" 
          class="retail-pro-btn retail-pro-btn-primary"
          (click)="openCustomerForm()">
          <mat-icon>person_add</mat-icon>
          Add Customer
        </button>
      </div>
    </div>

    <!-- Paginator -->
    <mat-paginator 
      [pageSizeOptions]="[10, 25, 50, 100]" 
      [showFirstLastButtons]="true"
      class="retail-pro-paginator">
    </mat-paginator>
  </div>
</div>